{% extends "main.html" %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
{% block content %}
    <div class="d-flex row">
        <div class="col-md-6">
            <div class="d-grid gap-2 d-md-block pt-1">
                {% if proposal %}
                    <a class="btn btn-warning " href="{% url "edit-client" proposal.client.id %}">Klient</a>
                    <a class="btn btn-secondary " href="{% url "edit-items" proposal.id %}">Upravit položky</a>
                    <a class="btn btn-info " href="{% url "generate-proposal" proposal.id %}">Náhled nabídky</a>
                    <a class="btn btn-dark " href="{% url "send-proposal" proposal.id %}">Odeslat klientovi</a>
                    <form method="post" action="{% url "create-contract" proposal.id %}" class="mt-2">
                        {% csrf_token %}
                        <button class="btn btn-primary col-3" type="submit">Vytvořit smlouvu</button>
                    </form>
                </div>
            {% endif %}
            <form action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <h4 class="mt-2">Údaje k doplnění do nabídky</h4>
                <div class="row">
                    {% if client_form %}
                        <p>{{ client_form.consumer|as_crispy_field }}</p>
                        <div class="row">
                            <div class="col-6">
                                {{ client_form.name|as_crispy_field }}
                            </div>
                            <div class="col-6">
                                {{ client_form.email|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                {{ client_form.id_number|as_crispy_field }}
                            </div>
                            <div class="col-6">
                                {{ client_form.phone_number|as_crispy_field }}
                            </div>
                        </div>
                        {{ client_form.address|as_crispy_field }}
                        {{ client_form.note|as_crispy_field }}
                    {% else %}
                        {{ edit_form.client|as_crispy_field }}
                    {% endif %}
                </div>
                <div class="row">
                    <div class="col-4">
                        {{ edit_form.proposal_number|as_crispy_field }}
                        {{ edit_form.subject|as_crispy_field }}
                        {{ edit_form.contract_type|as_crispy_field }}
                    </div>
                    <div class="col-8">
                        {{ edit_form.fulfillment_at|as_crispy_field }}
                        {{ edit_form.fulfillment_place|as_crispy_field }}
                        {{ upload_form.file|as_crispy_field }}
                    </div>
                    {% if "edit" in request.path %}
                        <div class="col-4">
                            {{ edit_form.signed_at|as_crispy_field }}
                        </div>
                    {% endif %}
                </div>
                <input class="btn btn-success" type="submit" value="Uložit">
            </form>
        </div>
        <div class="col-md-6">
            {% if proposal.items.all %}
                <h4>Platební podmínky</h4>
                <div class="row">
                    <p>Celková cena nabídky je {{ proposal.price }} Kč a je rozložena do plateb:</p>
                </div>
                <ol>
                    <form method="post" action="{% url "edit-payments" proposal.id %}">
                        {% csrf_token %}
                        {% for payment in proposal.payments.all %}
                            <li>
                                <div class="input-group">
                                    <span class="input-group-text" style="width: 35%">část ve výši {{ payment.amount }} Kč</span>
                                    <div class="form-floating">
                                        <input class="form-control" value="{{ payment.part }}" id="payment_part"
                                               name="payment_part">
                                        <label for="payment_part">% z celku</label>
                                    </div>
                                    <div class="form-floating">
                                        <select class="form-select" id="payment_due" name="payment_due">
                                            <option value="99" {% if payment.due == "99" %}selected{% endif %}>-
                                            </option>
                                            <option value="10" {% if payment.due == "10" %}selected{% endif %}>po
                                                podpisu smlouvy
                                            </option>
                                            {% if proposal.contract_type.type == "KOUPE" %}
                                                <option value="21" {% if payment.due == "21" %}selected{% endif %}>před
                                                    dodání
                                                </option>
                                                <option value="31" {% if payment.due == "31" %}selected{% endif %}>po
                                                    dodáním
                                                </option>
                                            {% elif proposal.contract_type.type == "DILO" %}
                                                <option value="22" {% if payment.due == "22" %}selected{% endif %}>před
                                                    dokončením
                                                </option>
                                                <option value="32" {% if payment.due == "32" %}selected{% endif %}>po
                                                    dokončení
                                                </option>
                                            {% endif %}
                                        </select>
                                        <label for="payment_due">splatná</label>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                        <button class="btn btn-success mt-1" type="submit">Aktualizovat platební podmínky</button>
                    </form>
                </ol>

                <a class="pt-2 h4" style="text-decoration: none !important; color: black;"
                   href="{% url "edit-items" proposal.id %}">Položky nabídky</a>
                <table class="table table-striped">
                    <thead>
                    <th scope="col">Pořadí</th>
                    <th scope="col">Název položky</th>
                    <th scope="col">Cena</th>
                    <th scope="col">Množství</th>
                    </thead>
                    <tbody>
                    {% for item in proposal.items.all %}
                        <tr>
                            <td>{{ item.priority }}</td>
                            <td>{{ item.title }}</td>
                            <td>{{ item.sale_price }}</td>
                            <td>{{ item.quantity }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% if proposal.uploaded.all %}
                <h4>Podkladová nabídka</h4>
                <p>Soubor {{ uploaded.file_name }} nahraný dne {{ uploaded.uploaded_at|date }}.
            {% endif %}
        </div>
    </div>

{% endblock %}
